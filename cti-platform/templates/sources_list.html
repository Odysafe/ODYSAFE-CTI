{% extends "base.html" %}

{% block title %}Sources - CTI Platform{% endblock %}

{% block content %}
<section class="section">
    <div class="container" style="max-width: 100%; overflow-x: auto; width: 100%;">
        <!-- Hero Section -->
        <div style="text-align: center; margin-bottom: 60px;">
            <h1 style="font-size: clamp(32px, 5vw, 48px); font-weight: 700; margin-bottom: 24px; background: linear-gradient(135deg, var(--violet-light), var(--violet-aurora)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                Sources
            </h1>
            <p style="font-size: 18px; color: var(--text-secondary); max-width: 800px; margin: 0 auto 32px; line-height: 1.6;">
                Manage all your CTI data sources. Organize your sources with drag-and-drop groups, analyze PDF files with YARA rules, view extraction statistics, and access the Data-Shield IPv4 blocklist for infrastructure protection.
            </p>
            
            <!-- Features -->
            <div style="background: rgba(139, 92, 246, 0.05); border: 1px solid rgba(167, 139, 250, 0.2); border-radius: 16px; padding: 32px; margin-top: 40px; text-align: left;">
                <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 20px; color: var(--text-primary); text-align: center;">
                    üîç Features
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; font-size: 14px;">
                    <div><strong>Group Management:</strong> Organize with drag-and-drop into custom groups</div>
                    <div><strong>YARA Analysis:</strong> Automatic PDF file analysis with YARA rules</div>
                    <div><strong>Detailed Statistics:</strong> Number of extracted IOCs, detected types, dates</div>
                    <div><strong>Data-Shield Blocklist:</strong> IPv4 blocklist for firewall/WAF protection</div>
                    <div><strong>Bulk Actions:</strong> Multiple selection and bulk deletion</div>
                    <div><strong>Trash:</strong> Reversible deletion with restoration capability</div>
                    <div><strong>Filtering:</strong> Search and sort by name, date, number of IOCs</div>
                    <div><strong>Complete Details:</strong> View context and metadata for each source</div>
                </div>
                <p style="text-align: center; margin-top: 20px; color: var(--text-secondary); font-size: 13px;">
                    Sources can be organized into groups to facilitate management and analysis
                </p>
            </div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px;">
            <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                <div style="font-size: 13px; color: var(--text-secondary); max-width: 400px;">
                    <strong style="color: var(--text-primary);">Data-Shield IPv4 Blocklist:</strong> Malicious IP addresses for firewall/WAF protection. <strong style="color: #6D28D9;">Thanks to <a href="https://github.com/duggytuxy/Data-Shield_IPv4_Blocklist" target="_blank" style="color: #6D28D9; text-decoration: none;">Data-Shield</a>!</strong>
                </div>
                <button type="button" onclick="refreshDataShield()" class="btn btn-secondary" style="padding: 8px 16px;" id="data-shield-refresh-btn-sources">
                    üîÑ Refresh Data-Shield Blocklist
                </button>
            </div>
        </div>

        <!-- Groups Panel (Drag & Drop) - Modern Style -->
        <div style="display: grid; grid-template-columns: minmax(280px, 320px) 1fr; gap: 24px; margin-bottom: 24px; align-items: start;" class="sources-layout-grid">
            <!-- Groups Sidebar -->
            <div class="card groups-sidebar" style="height: fit-content; position: sticky; top: 20px; max-height: calc(100vh - 140px); overflow-y: auto; overflow-x: hidden; padding: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: var(--text-primary); font-weight: 600;">Groups</h3>
                </div>
                <div id="groups-container" style="display: flex; flex-direction: column; gap: 10px; max-height: calc(100vh - 300px); overflow-y: auto;">
                    {% if all_groups %}
                        {% for group in all_groups %}
                        <div class="group-drop-zone" 
                             data-group-id="{{ group.id }}" 
                             draggable="true"
                             ondragstart="handleGroupDragStart(event, {{ group.id }})"
                             ondragend="handleGroupDragEnd(event)"
                             ondrop="handleDrop(event, {{ group.id }})" 
                             ondragover="handleDragOver(event)"
                             ondragleave="handleDragLeave(event)"
                             style="padding: 16px; background: {{ (group.color or '#8B5CF6') }}25; border-radius: 12px; min-height: 70px; border: 2px dashed transparent; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); ody: move; position: relative; display: flex; flex-direction: column; justify-content: space-between; box-sizing: border-box; width: 100%; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                             onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'"
                             onmouseout="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <div style="width: 12px; height: 12px; background: {{ group.color or '#8B5CF6' }}; border-radius: 50%; flex-shrink: 0;"></div>
                                <div style="flex: 1; min-width: 0;">
                                    <strong style="color: {{ group.color or '#8B5CF6' }}; font-size: 14px; line-height: 1.3; font-weight: 600; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ group.name }}</strong>
                                </div>
                                <span class="group-count" style="color: {{ group.color or '#8B5CF6' }}; font-size: 13px; opacity: 0.9; font-weight: 600; flex-shrink: 0;">0</span>
                            </div>
                            <div style="font-size: 11px; color: {{ group.color or '#8B5CF6' }}; opacity: 0.7; margin-top: auto; padding-top: 4px;">Drag and drop sources here</div>
                            {% set is_system_group = group.name in ['default', 'True Positive', 'False Positive', 'TLP:CLEAR', 'TLP:GREEN', 'TLP:AMBER', 'TLP:RED'] %}
                            {% if not is_system_group %}
                            <button onclick="event.stopPropagation(); deleteGroup({{ group.id }})" 
                                    style="position: absolute; top: 8px; right: 8px; background: rgba(220, 38, 38, 0.8); color: white; border: none; border-radius: 6px; width: 24px; height: 24px; ody: pointer; font-size: 16px; line-height: 1; display: flex; align-items: center; justify-content: center; z-index: 10; transition: all 0.2s ease;"
                                    onmouseover="this.style.background='rgba(220, 38, 38, 1)'; this.style.transform='scale(1.1)'"
                                    onmouseout="this.style.background='rgba(220, 38, 38, 0.8)'; this.style.transform='scale(1)'"
                                    title="Delete the group">√ó</button>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 16px;">üìÅ</div>
                        <p>No groups yet</p>
                    </div>
                    {% endif %}
                </div>
                <button class="btn btn-primary" onclick="openCreateGroupModal()" style="width: 100%; margin-top: 16px; display: flex; align-items: center; justify-content: center; gap: 6px;">
                    <span>‚ûï</span> Create Group
                </button>
            </div>

            <!-- Sources Table -->
            <div>
                {% if sources %}
                <div class="card" style="margin-bottom: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <label style="display: flex; align-items: center; gap: 8px; ody: pointer;">
                                <input type="checkbox" id="select-all-sources" style="width: 18px; height: 18px; ody: pointer;">
                                <span style="font-weight: 500;">Select all</span>
                            </label>
                            <span id="selected-count" style="color: var(--text-secondary); font-size: 14px; display: none;">
                                <span id="selected-number">0</span> source(s) selected
                            </span>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button type="button" id="bulk-delete-btn" class="btn btn-secondary" style="background: rgba(220, 38, 38, 0.1); color: #DC2626; border-color: #DC2626; display: none;" onclick="bulkDeleteSources()">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                </div>

                <div class="table-responsive" style="overflow-x: auto; overflow-y: visible; width: 100%; max-width: 100%;">
                    <table class="table" style="width: 100%; table-layout: auto; border-collapse: collapse; max-width: 100%;">
                        <thead>
                            <tr>
                                <th style="width: 40px; padding: 12px 16px; vertical-align: middle;">
                                    <input type="checkbox" id="select-all-header" style="width: 18px; height: 18px; ody: pointer;">
                                </th>
                                <th style="padding: 12px 16px; vertical-align: middle;">Name</th>
                                <th style="padding: 12px 16px; vertical-align: middle;">Context</th>
                                <th style="padding: 12px 16px; vertical-align: middle;">Type</th>
                                <th style="padding: 12px 16px; vertical-align: middle;">Status</th>
                                <th style="padding: 12px 16px; vertical-align: middle; min-width: 180px;">Group</th>
                                <th style="padding: 12px 16px; vertical-align: middle;">Created</th>
                                <th style="padding: 12px 16px; vertical-align: middle;">Export</th>
                                <th style="padding: 12px 16px; vertical-align: middle;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for source in sources %}
                            <tr data-source-id="{{ source.id }}" 
                                draggable="true" 
                                ondragstart="handleDragStart(event, {{ source.id }})"
                                ondragend="handleDragEnd(event)"
                                ondrop="handleSourceDrop(event, {{ source.id }})"
                                ondragover="handleSourceDragOver(event)"
                                ondragleave="handleSourceDragLeave(event)"
                                style="ody: move; vertical-align: middle;">
                                <td style="padding: 12px 16px; vertical-align: middle;">
                                    <input type="checkbox" class="source-checkbox" data-source-id="{{ source.id }}" style="width: 18px; height: 18px; ody: pointer;">
                                </td>
                                <td style="font-weight: 500; padding: 12px 16px; vertical-align: middle;">{{ source.name }}</td>
                                <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--text-secondary); padding: 12px 16px; vertical-align: middle;">
                                    {{ source.context }}
                                </td>
                                <td style="padding: 12px 16px; vertical-align: middle;">
                                    <span class="badge">{{ source.source_type }}</span>
                                </td>
                                <td style="padding: 12px 16px; vertical-align: middle;">
                                    {% if source.status == 'processing' %}
                                    <div class="progress-container" data-source-id="{{ source.id }}" style="min-width: 150px;">
                                        <div class="progress-bar-wrapper" style="background: rgba(139, 92, 246, 0.1); border-radius: 8px; height: 24px; position: relative; overflow: hidden;">
                                            <div class="progress-bar" style="background: linear-gradient(90deg, #8B5CF6 0%, #7C3AED 100%); height: 100%; width: 0%; transition: width 0.3s ease; border-radius: 8px;"></div>
                                            <div class="progress-text" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 11px; font-weight: 600; color: #8B5CF6; z-index: 1; white-space: nowrap;">
                                                <span class="progress-percentage">0%</span>
                                            </div>
                                        </div>
                                        <div class="progress-message" style="font-size: 11px; color: var(--text-secondary); margin-top: 4px; text-align: center;">
                                            <span class="progress-msg">Waiting...</span>
                                        </div>
                                    </div>
                                    {% else %}
                                    <span class="badge" style="background: {% if source.status == 'completed' %}rgba(34, 197, 94, 0.1); color: var(--green-positive);{% elif source.status == 'error' %}rgba(220, 38, 38, 0.1); color: var(--red-alert);{% else %}rgba(139, 92, 246, 0.1); color: var(--violet-light);{% endif %}">
                                        {{ source.status }}
                                    </span>
                                    {% endif %}
                                </td>
                                <td style="vertical-align: middle; padding: 12px 16px; max-width: 300px;">
                                    <div style="display: flex; flex-direction: column; gap: 4px; align-items: flex-start; justify-content: center; min-height: 40px; width: 100%; max-width: 100%; overflow: hidden;">
                                        {% if source.groups %}
                                            {% for group in source.groups %}
                                                <span class="badge" style="background: {{ (group.color or '#8B5CF6') }}25; color: {{ group.color or '#8B5CF6' }}; padding: 6px 12px; font-size: 12px; font-weight: 500; display: inline-flex; align-items: center; gap: 6px; border-radius: 8px; border: 1px solid {{ (group.color or '#8B5CF6') }}40; box-shadow: 0 1px 3px rgba(0,0,0,0.1); line-height: 1.4; white-space: nowrap; max-width: 100%; box-sizing: border-box; width: 100%; overflow: hidden; transition: all 0.2s ease;">
                                                    <span style="width: 8px; height: 8px; background: {{ group.color or '#8B5CF6' }}; border-radius: 50%; display: inline-block; flex-shrink: 0;"></span>
                                                    <span style="display: inline-block; max-width: calc(100% - 30px); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; min-width: 0;">{{ group.name }}</span>
                                                    <span onclick="removeSourceFromGroup({{ source.id }}, {{ group.id }})" style="ody: pointer; font-weight: bold; color: #DC2626; margin-left: 2px; font-size: 12px; line-height: 1; flex-shrink: 0; display: inline-block; padding: 0 2px;" title="Remove from group" onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">√ó</span>
                                                </span>
                                            {% endfor %}
                                        {% else %}
                                            <span style="color: var(--text-muted); font-style: italic; display: inline-block; vertical-align: middle; line-height: 1.4;">No groups</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td style="color: var(--text-muted); font-size: 14px; padding: 12px 16px; vertical-align: middle;">
                                    {{ source.created_at }}
                                </td>
                                <td style="padding: 12px 16px; vertical-align: middle;">
                                    <a href="{{ url_for('export') }}" class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px; text-decoration: none;">
                                        üì§ Export
                                    </a>
                                </td>
                                <td style="padding: 12px 16px; vertical-align: middle;">
                                    <div style="display: flex; gap: 4px; align-items: center; flex-wrap: wrap;">
                                        <a href="{{ url_for('iocs_list', source=source.name) }}" class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;">
                                            View
                                        </a>
                                        <button type="button" onclick="markSourceAsTruePositive({{ source.id }})" 
                                                style="background: rgba(16, 185, 129, 0.1); color: #10B981; border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 4px; padding: 4px 8px; font-size: 12px; ody: pointer; transition: all 0.2s;" 
                                                onmouseover="this.style.background='rgba(16, 185, 129, 0.2)'" 
                                                onmouseout="this.style.background='rgba(16, 185, 129, 0.1)'" 
                                                title="Mark as True Positive">
                                            ‚úì True Positive
                                        </button>
                                        <button type="button" onclick="markSourceAsFalsePositive({{ source.id }})" 
                                                style="background: rgba(220, 38, 38, 0.1); color: #DC2626; border: 1px solid rgba(220, 38, 38, 0.3); border-radius: 4px; padding: 4px 8px; font-size: 12px; ody: pointer; transition: all 0.2s;" 
                                                onmouseover="this.style.background='rgba(220, 38, 38, 0.2)'" 
                                                onmouseout="this.style.background='rgba(220, 38, 38, 0.1)'" 
                                                title="Mark as False Positive">
                                            ‚úó False Positive
                                        </button>
                                        <button type="button" onclick="confirmDeleteSource({{ source.id }})" style="background: rgba(220, 38, 38, 0.1); color: #DC2626; border: 1px solid rgba(220, 38, 38, 0.3); border-radius: 4px; padding: 4px 8px; font-size: 12px; ody: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(220, 38, 38, 0.2)'" onmouseout="this.style.background='rgba(220, 38, 38, 0.1)'" title="Delete source">
                                            √ó
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
        {% else %}
        <div class="card" style="text-align: center; padding: 64px 0;">
            <div style="font-size: 48px; margin-bottom: 16px;">üìÅ</div>
            <p style="color: var(--text-secondary); margin-bottom: 24px;">No sources yet</p>
            <a href="{{ url_for('upload') }}" class="btn btn-primary">IOC Extractions</a>
        </div>
        {% endif %}
    </div>
</section>


<!-- Create Group Modal -->
<div id="create-group-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(4px);">
    <div style="background: white; border-radius: 16px; max-width: 400px; width: 90%; padding: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <h3 style="margin-top: 0; margin-bottom: 16px; color: var(--violet-light); font-weight: 600;">Create New Group</h3>
        <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label" style="color: var(--violet-light); font-weight: 500;">Group Name</label>
            <input type="text" id="new-group-name" class="form-control" placeholder="Enter group name...">
        </div>
        <div class="form-group" style="margin-bottom: 16px;">
            <label class="form-label" style="color: var(--violet-light); font-weight: 500;">Color</label>
            <input type="color" id="new-group-color" value="#8B5CF6" style="height: 38px; border-radius: 6px; border: 1px solid #ddd; ody: pointer; width: 100%;">
        </div>
        <div style="display: flex; gap: 8px; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="closeCreateGroupModal()">Cancel</button>
            <button class="btn btn-primary" onclick="createGroupOnly()">Create</button>
        </div>
    </div>
</div>

<script>
// Function to update source progress
function updateSourceProgress(sourceId) {
    const progressContainer = document.querySelector(`.progress-container[data-source-id="${sourceId}"]`);
    if (!progressContainer) return;
    
    fetch(`/api/progress/source_${sourceId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.progress) {
                const progress = data.progress;
                const progressBar = progressContainer.querySelector('.progress-bar');
                const progressPercentage = progressContainer.querySelector('.progress-percentage');
                const progressMessage = progressContainer.querySelector('.progress-msg');
                
                if (progressBar && progressPercentage) {
                    const percentage = progress.percentage || 0;
                    progressBar.style.width = percentage + '%';
                    progressPercentage.textContent = percentage + '%';
                }
                
                if (progressMessage && progress.message) {
                    progressMessage.textContent = progress.message;
                }
                
                // If completed or error, stop polling and update display
                if (progress.status === 'completed' || progress.status === 'error') {
                    // Update status in table without reloading
                    setTimeout(() => {
                        updateSourceStatus(sourceId, progress.status);
                    }, 500);
                    return; // Stop polling
                }
            }
        })
        .catch(error => {
            console.error('Error retrieving progress:', error);
        });
}

// Polling for sources in processing
function startProgressPolling() {
    const processingSources = document.querySelectorAll('.progress-container');
    processingSources.forEach(container => {
        const sourceId = container.getAttribute('data-source-id');
        if (sourceId) {
            // Update immediately
            updateSourceProgress(sourceId);
            // Then every 2 seconds
            setInterval(() => updateSourceProgress(sourceId), 2000);
        }
    });
}

// Load recent sources (global function)
async function loadRecentSources() {
    const container = document.getElementById('recent-sources-content');
    if (!container) {
        console.error('Container recent-sources-content not found');
        return;
    }
    
    const btn = document.getElementById('refresh-sources-btn');
    if (btn) {
        btn.disabled = true;
        btn.textContent = '‚è≥ Loading...';
    }
    
    try {
        const response = await fetch('/api/sources/recent');
        const data = await response.json();
        
        if (response.ok && data.sources) {
            renderRecentSources(data.sources);
        } else {
            container.innerHTML = '<div style="text-align: center; padding: 32px; color: var(--text-secondary);">Error loading</div>';
        }
    } catch (error) {
        console.error('Error loading recent sources:', error);
        if (container) {
            container.innerHTML = '<div style="text-align: center; padding: 32px; color: var(--text-secondary);">Error loading</div>';
        }
    } finally {
        if (btn) {
            btn.disabled = false;
            btn.textContent = 'üîÑ Refresh';
        }
    }
}

function renderRecentSources(sources) {
    const container = document.getElementById('recent-sources-content');
    
    if (!sources || sources.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 64px; color: var(--text-secondary);"><div style="font-size: 48px; margin-bottom: 16px;">üìÅ</div><p>No recent source</p></div>';
        return;
    }
    
    let html = '<div class="table-responsive" style="overflow-x: auto;"><table class="table"><thead><tr><th>Name</th><th>Type</th><th>Status</th><th>Created</th><th>Actions</th></tr></thead><tbody>';
    
    sources.forEach(source => {
        const createdDate = new Date(source.created_at).toLocaleString('en-US');
        const typeLabels = {
            'file_upload': 'File',
            'paste': 'Paste',
            'url': 'URL'
        };
        
        html += `
            <tr>
                <td style="font-weight: 500;">${escapeHtml(source.name)}</td>
                <td><span class="badge">${typeLabels[source.source_type] || source.source_type}</span></td>
                <td><span class="badge" style="background: ${source.status === 'completed' ? 'rgba(34, 197, 94, 0.1); color: var(--green-positive);' : source.status === 'error' ? 'rgba(220, 38, 38, 0.1); color: var(--red-alert);' : 'rgba(139, 92, 246, 0.1); color: var(--violet-light);'}">${escapeHtml(source.status)}</span></td>
                <td style="color: var(--text-secondary);">${createdDate}</td>
                <td>
                    ${source.file_available ? `<button type="button" class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="downloadSource(${source.id})">
                        üì• Download
                    </button>` : '<span style="color: var(--text-secondary); font-size: 12px;">No file</span>'}
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

async function downloadSource(sourceId) {
    try {
        const response = await fetch(`/api/sources/${sourceId}/download`);
        
        if (response.ok) {
            const blob = await response.blob();
            const downloadUrl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            // Get filename from headers
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = `source_${sourceId}.txt`;
            if (contentDisposition) {
                const filenameMatch = contentDisposition.match(/filename="?(.+)"?/);
                if (filenameMatch) {
                    filename = filenameMatch[1];
                }
            }
            a.href = downloadUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(downloadUrl);
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function updateSourceStatus(sourceId, status) {
    const row = document.querySelector(`tr[data-source-id="${sourceId}"]`);
    if (!row) return;
    
    const statusTd = row.querySelector('td:nth-child(5)'); // 5th column = Status
    if (!statusTd) return;
    
    const statusBadge = {
        'completed': '<span class="badge" style="background: rgba(34, 197, 94, 0.1); color: var(--green-positive);">completed</span>',
        'error': '<span class="badge" style="background: rgba(220, 38, 38, 0.1); color: var(--red-alert);">error</span>',
        'pending': '<span class="badge" style="background: rgba(139, 92, 246, 0.1); color: var(--violet-light);">pending</span>'
    };
    
    statusTd.innerHTML = statusBadge[status] || statusBadge['pending'];
}

window.downloadSource = downloadSource;
window.loadRecentSources = loadRecentSources;
window.updateSourceStatus = updateSourceStatus;

// Drag & Drop Functions
let draggedSourceId = null;
let draggedGroupId = null;

function handleDragStart(event, sourceId) {
    draggedSourceId = sourceId;
    draggedGroupId = null;
    event.dataTransfer.effectAllowed = 'move';
    event.currentTarget.style.opacity = '0.5';
}

function handleDragEnd(event) {
    event.currentTarget.style.opacity = '1';
    // Remove drag-over styling from all drop zones
    document.querySelectorAll('.group-drop-zone').forEach(zone => {
        zone.style.borderColor = 'transparent';
        const originalColor = zone.getAttribute('data-original-color');
        if (originalColor) {
            zone.style.background = originalColor;
        }
    });
    // Remove drag-over styling from all source rows
    document.querySelectorAll('tr[data-source-id]').forEach(row => {
        row.style.borderColor = '';
        row.style.backgroundColor = '';
    });
}

function handleGroupDragStart(event, groupId) {
    draggedGroupId = groupId;
    draggedSourceId = null;
    event.dataTransfer.effectAllowed = 'move';
    event.currentTarget.style.opacity = '0.7';
    event.stopPropagation();
}

function handleGroupDragEnd(event) {
    event.currentTarget.style.opacity = '1';
    // Remove drag-over styling from all source rows
    document.querySelectorAll('tr[data-source-id]').forEach(row => {
        row.style.borderColor = '';
        row.style.backgroundColor = '';
    });
}

function handleDragOver(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'move';
    const dropZone = event.currentTarget;
    const originalColor = dropZone.style.background;
    dropZone.setAttribute('data-original-color', originalColor);
    dropZone.style.borderColor = 'white';
    dropZone.style.borderWidth = '2px';
    dropZone.style.borderStyle = 'dashed';
}

function handleDragLeave(event) {
    const dropZone = event.currentTarget;
    const originalColor = dropZone.getAttribute('data-original-color');
    if (originalColor) {
        dropZone.style.borderColor = 'transparent';
        dropZone.style.background = originalColor;
    }
}

async function handleDrop(event, groupId) {
    event.preventDefault();
    const dropZone = event.currentTarget;
    const originalColor = dropZone.getAttribute('data-original-color');
    if (originalColor) {
        dropZone.style.borderColor = 'transparent';
        dropZone.style.background = originalColor;
    }
    
    if (!draggedSourceId) return;
    
    try {
        const response = await fetch('/api/sources/bulk-add-group', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ source_ids: [draggedSourceId], group_id: groupId })
        });
        
        const data = await response.json();
        if (response.ok) {
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
    
    draggedSourceId = null;
}

function handleSourceDragOver(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'move';
    const sourceRow = event.currentTarget;
    sourceRow.style.borderColor = 'rgba(139, 92, 246, 0.5)';
    sourceRow.style.borderWidth = '2px';
    sourceRow.style.borderStyle = 'dashed';
    sourceRow.style.backgroundColor = 'rgba(139, 92, 246, 0.1)';
}

function handleSourceDragLeave(event) {
    const sourceRow = event.currentTarget;
    sourceRow.style.borderColor = '';
    sourceRow.style.backgroundColor = '';
}

async function handleSourceDrop(event, sourceId) {
    event.preventDefault();
    const sourceRow = event.currentTarget;
    sourceRow.style.borderColor = '';
    sourceRow.style.backgroundColor = '';
    
    if (!draggedGroupId) return;
    
    try {
        const response = await fetch('/api/sources/bulk-add-group', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ source_ids: [sourceId], group_id: draggedGroupId })
        });
        
        const data = await response.json();
        if (response.ok) {
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
    
    draggedGroupId = null;
}




// Group Management Functions
function openCreateGroupModal() {
    document.getElementById('create-group-modal').style.display = 'flex';
}

function closeCreateGroupModal() {
    document.getElementById('create-group-modal').style.display = 'none';
    document.getElementById('new-group-name').value = '';
    document.getElementById('new-group-color').value = '#8B5CF6';
}

async function createGroupOnly() {
    const name = document.getElementById('new-group-name').value.trim();
    const color = document.getElementById('new-group-color').value;
    
    if (!name) {
        alert('Please enter a group name');
        return;
    }
    
    try {
        const response = await fetch('/api/groups/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, color })
        });
        
        const data = await response.json();
        if (response.ok) {
            closeCreateGroupModal();
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function removeSourceFromGroup(sourceId, groupId) {
    if (!confirm('Remove this source from the group?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/sources/remove-group', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ source_id: sourceId, group_id: groupId })
        });
        
        const data = await response.json();
        if (response.ok) {
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function deleteGroup(groupId) {
    if (!confirm('Are you sure you want to delete this group? All associations with sources will be deleted. This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/groups/${groupId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        if (response.ok) {
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Update group counts on page load
function updateGroupCounts() {
    {% if sources %}
    const sources = {{ sources|tojson }};
    const groupCounts = {};
    
    sources.forEach(source => {
        if (source.groups && source.groups.length > 0) {
            source.groups.forEach(group => {
                // Count all groups (not just system groups)
                if (!groupCounts[group.id]) {
                    groupCounts[group.id] = 0;
                }
                groupCounts[group.id]++;
            });
        }
    });
    
    Object.keys(groupCounts).forEach(groupId => {
        const countElement = document.querySelector(`.group-drop-zone[data-group-id="${groupId}"] .group-count`);
        if (countElement) {
            countElement.textContent = groupCounts[groupId];
        }
    });
    {% endif %}
}

// Check processes in progress on page load
function checkRunningProcesses() {
    // Check all sources in processing
    const processingSources = document.querySelectorAll('.progress-container');
    processingSources.forEach(container => {
        const sourceId = container.getAttribute('data-source-id');
        if (sourceId) {
            // Check status via API
            fetch(`/api/progress/source_${sourceId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.progress) {
                        const progress = data.progress;
                        if (progress.status === 'running' || progress.status === 'stopping') {
                            // Process is still in progress, update display
                            updateSourceProgress(sourceId);
                        }
                    }
                })
                .catch(error => {
                    console.error('Process verification error:', error);
                });
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    startProgressPolling();
    // Check processes in progress
    checkRunningProcesses();
    // Load recent sources after a short delay
    setTimeout(() => {
        loadRecentSources();
    }, 500);
    // Update group counts
    updateGroupCounts();
    
    const selectAllCheckbox = document.getElementById('select-all-sources');
    const selectAllHeader = document.getElementById('select-all-header');
    const sourceCheckboxes = document.querySelectorAll('.source-checkbox');
    const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
    const selectedCount = document.getElementById('selected-count');
    const selectedNumber = document.getElementById('selected-number');

    function updateSelectionUI() {
        const checked = document.querySelectorAll('.source-checkbox:checked');
        const count = checked.length;
        
        if (count > 0) {
            bulkDeleteBtn.style.display = 'block';
            selectedCount.style.display = 'inline';
            selectedNumber.textContent = count;
        } else {
            bulkDeleteBtn.style.display = 'none';
            selectedCount.style.display = 'none';
        }
        
        // Update "Select all" checkboxes
        if (count === sourceCheckboxes.length && sourceCheckboxes.length > 0) {
            selectAllCheckbox.checked = true;
            selectAllHeader.checked = true;
        } else {
            selectAllCheckbox.checked = false;
            selectAllHeader.checked = false;
        }
    }

    function toggleAll(checked) {
        sourceCheckboxes.forEach(cb => {
            cb.checked = checked;
        });
        updateSelectionUI();
    }

    selectAllCheckbox.addEventListener('change', function() {
        toggleAll(this.checked);
    });

    selectAllHeader.addEventListener('change', function() {
        toggleAll(this.checked);
    });

    sourceCheckboxes.forEach(cb => {
        cb.addEventListener('change', updateSelectionUI);
    });

    window.bulkDeleteSources = async function() {
        const checked = document.querySelectorAll('.source-checkbox:checked');
        const sourceIds = Array.from(checked).map(cb => parseInt(cb.dataset.sourceId));
        
        if (sourceIds.length === 0) {
            alert('No source selected');
            return;
        }
        
        if (!confirm(`Move ${sourceIds.length} source(s) to trash?`)) {
            return;
        }
        
        try {
            const response = await fetch('/api/sources/bulk-delete', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({source_ids: sourceIds})
            });
            
            const data = await response.json();
            
            if (response.ok) {
                // Remove sources from display without reloading
                sourceIds.forEach(id => {
                    const row = document.querySelector(`tr[data-source-id="${id}"]`);
                    if (row) {
                        row.style.transition = 'opacity 0.3s';
                        row.style.opacity = '0';
                        setTimeout(() => row.remove(), 300);
                    }
                });
                // Update UI
                updateSelectionUI();
                alert(data.message || 'Sources moved to trash');
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    };
});

// Delete source functions
let sourceToDelete = null;

function confirmDeleteSource(sourceId) {
    sourceToDelete = sourceId;
    document.getElementById('delete-source-modal').style.display = 'flex';
}

function closeDeleteModal() {
    sourceToDelete = null;
    document.getElementById('delete-source-modal').style.display = 'none';
}

async function executeDeleteSource() {
    if (!sourceToDelete) return;
    
    const btn = document.getElementById('confirm-delete-btn');
    btn.disabled = true;
    btn.textContent = 'Deleting...';
    
    try {
        const response = await fetch(`/api/sources/${sourceToDelete}/delete`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (response.ok) {
            closeDeleteModal();
            // Remove source from display
            const row = document.querySelector(`tr[data-source-id="${sourceToDelete}"]`);
            if (row) {
                row.style.transition = 'opacity 0.3s';
                row.style.opacity = '0';
                setTimeout(() => row.remove(), 300);
            }
            // Update selection UI
            updateSelectionUI();
            // Reload page to update counts
            setTimeout(() => location.reload(), 500);
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
            btn.disabled = false;
            btn.textContent = 'Delete';
        }
    } catch (error) {
        alert('Error: ' + error.message);
        btn.disabled = false;
        btn.textContent = 'Delete';
    }
}

async function markSourceAsTruePositive(sourceId) {
    try {
        // Get group ID for "True Positive"
        const groupResponse = await fetch('/api/groups/get-by-name?name=True Positive');
        const groupData = await groupResponse.json();
        
        if (!groupResponse.ok || !groupData.group_id) {
            alert('Error: True Positive group not found');
            return;
        }
        
        const groupId = groupData.group_id;
        
        // Add source to group
        const response = await fetch('/api/sources/bulk-add-group', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ source_ids: [sourceId], group_id: groupId })
        });
        
        const data = await response.json();
        if (response.ok) {
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function markSourceAsFalsePositive(sourceId) {
    try {
        // Get group ID for "False Positive"
        const groupResponse = await fetch('/api/groups/get-by-name?name=False Positive');
        const groupData = await groupResponse.json();
        
        if (!groupResponse.ok || !groupData.group_id) {
            alert('Error: False Positive group not found');
            return;
        }
        
        const groupId = groupData.group_id;
        
        // Add source to group
        const response = await fetch('/api/sources/bulk-add-group', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ source_ids: [sourceId], group_id: groupId })
        });
        
        const data = await response.json();
        if (response.ok) {
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}
</script>

<style>
/* Modern-like Design System for Sources Page */

/* Modern Group Badges */
.modern-group-badge {
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.modern-group-badge:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
}

.badge-remove-btn {
    transition: all 0.2s ease;
}

.badge-remove-btn:hover {
    transform: scale(1.1);
}

/* Add Group Button */
.add-group-btn {
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.add-group-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(139, 92, 246, 0.2);
}

.add-group-btn:active {
    transform: translateY(0);
}

/* Group Filter Chips */
.group-filter-chip {
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid;
}

.group-filter-chip:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.group-filter-chip:active {
    transform: translateY(0) scale(0.98);
}

/* Modern Context Menu */
.modern-context-menu {
    animation: menuFadeIn 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    backdrop-filter: blur(20px) saturate(180%);
}

@keyframes menuFadeIn {
    from {
        opacity: 0;
        transform: translateY(-8px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.menu-option {
    transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}

.menu-option:active {
    transform: scale(0.98);
}

/* Table Improvements */
.table {
    width: 100%;
    border-collapse: collapse;
}

.table th,
.table td {
    vertical-align: middle;
    padding: 14px 18px;
}

.table th {
    font-weight: 600;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-secondary);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.table-responsive {
    width: 100%;
    overflow-x: auto;
    overflow-y: visible;
    -webkit-overflow-scrolling: touch;
    border-radius: 12px;
}

/* Card Improvements */
.card {
    border-radius: 12px;
    padding: 20px 24px;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.08);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.card:hover {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    border-color: rgba(255, 255, 255, 0.12);
}

/* Group Drop Zone Styles */
.group-drop-zone {
    min-height: 70px !important;
    padding: 16px !important;
    box-sizing: border-box;
    -webkit-box-sizing: border-box;
    -moz-box-sizing: border-box;
    width: 100% !important;
    max-width: 100% !important;
    overflow: hidden !important;
}

.group-drop-zone:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.15) !important;
}

.sources-layout-grid {
    width: 100%;
    box-sizing: border-box;
    -webkit-box-sizing: border-box;
    -moz-box-sizing: border-box;
}

/* Responsive Design */
@media (max-width: 1024px) {
    .sources-layout-grid {
        grid-template-columns: 1fr !important;
    }
    
    .groups-sidebar {
        position: relative !important;
        top: 0 !important;
        max-height: 400px !important;
        margin-bottom: 24px;
        overflow: hidden !important;
        width: 100% !important;
        max-width: 100% !important;
    }
    
    .groups-sidebar #groups-container {
        max-height: 350px !important;
        overflow-x: hidden !important;
        width: 100% !important;
        max-width: 100% !important;
    }
}

@media (max-width: 768px) {
    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .table {
        min-width: 800px;
    }
    
    .table th,
    .table td {
        padding: 12px 14px;
        font-size: 14px;
    }
    
    .sources-layout-grid {
        gap: 16px !important;
    }
    
    .groups-sidebar {
        max-height: 300px !important;
    }
    
    .groups-sidebar #groups-container {
        max-height: 250px !important;
    }
}

@media (max-width: 480px) {
    .table {
        min-width: 1000px;
    }
    
    .table th,
    .table td {
        padding: 10px 12px;
        font-size: 13px;
    }
    
    .sources-layout-grid {
        gap: 12px !important;
    }
    
    .groups-sidebar h3 {
        font-size: 18px !important;
    }
    
    .group-drop-zone {
        padding: 12px !important;
        min-height: 60px !important;
    }
}
</style>

<!-- Delete Confirmation Modal -->
<div id="delete-source-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 24px; border-radius: 12px; max-width: 400px; width: 90%;">
        <h3 style="margin-top: 0; color: #DC2626;">Confirm Deletion</h3>
        <p>Are you sure you want to delete this source? All associated IOCs will also be deleted. This action cannot be undone.</p>
        <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px;">
            <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
            <button class="btn btn-danger" onclick="executeDeleteSource()" id="confirm-delete-btn">Delete</button>
        </div>
    </div>
</div>

<!-- Data-Shield Refresh Modal -->
<div id="data-shield-refresh-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(4px);">
    <div style="background: white; border-radius: 16px; max-width: 500px; width: 90%; padding: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
        <h3 style="margin-top: 0; margin-bottom: 16px; color: #6D28D9; font-weight: 600;">Refresh Data-Shield Blocklist</h3>
        <div id="data-shield-refresh-content" style="color: #6D28D9; margin-bottom: 20px; line-height: 1.6;">
            <p style="margin-bottom: 12px; font-weight: 500;">Data-Shield IPv4 Blocklist provides:</p>
            <ul style="margin: 0; padding-left: 20px; list-style-type: disc;">
                <li style="margin-bottom: 8px;">Additional protection layer via blocking malicious IPs</li>
                <li style="margin-bottom: 8px;">Network noise reduction (~50%)</li>
                <li style="margin-bottom: 8px;">Block approximately 95% of malicious bot traffic</li>
                <li style="margin-bottom: 8px;">Automatic updates every 24 hours</li>
                <li style="margin-bottom: 8px;">Low false positive rate (99.5% accuracy)</li>
            </ul>
            <p style="margin-top: 16px; color: var(--text-secondary); font-size: 14px;">
                This will download the latest malicious IPv4 IP list from Data-Shield and automatically import all IPs. Thanks to Data-Shield for providing this blocklist!
            </p>
        </div>
        <div id="data-shield-loading" style="display: none; text-align: center; margin: 20px 0;">
            <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #6D28D9; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="margin-top: 12px; color: #6D28D9; font-weight: 500;">Downloading malicious IPv4 IP list...</p>
            <p style="margin-top: 8px; color: var(--text-secondary); font-size: 12px;" id="data-shield-status">Please wait, this may take a few minutes</p>
        </div>
        <div id="data-shield-refresh-buttons" style="display: flex; gap: 8px; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="closeDataShieldRefreshModal()" id="cancel-refresh-btn-sources">Cancel</button>
            <button class="btn btn-primary" onclick="confirmDataShieldRefresh()" id="confirm-refresh-btn-sources">Refresh</button>
        </div>
    </div>
</div>

<script>
// Data-Shield functions for Sources page
function refreshDataShield() {
    document.getElementById('data-shield-refresh-modal').style.display = 'flex';
}

function closeDataShieldRefreshModal() {
    document.getElementById('data-shield-refresh-modal').style.display = 'none';
}

async function confirmDataShieldRefresh() {
    const btn = document.getElementById('confirm-refresh-btn-sources');
    const cancelBtn = document.getElementById('cancel-refresh-btn-sources');
    const content = document.getElementById('data-shield-refresh-content');
    const loading = document.getElementById('data-shield-loading');
    const buttons = document.getElementById('data-shield-refresh-buttons');
    const status = document.getElementById('data-shield-status');
    
    // Show loading animation
    content.style.display = 'none';
    buttons.style.display = 'none';
    loading.style.display = 'block';
    
    btn.disabled = true;
    cancelBtn.disabled = true;
    
    try {
        status.textContent = 'Downloading malicious IPv4 IP list from Data-Shield...';
        
        const response = await fetch('/api/data-shield/update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (response.ok) {
            status.textContent = 'Importing IPs into database...';
            
            // Wait a bit to show the import message
            await new Promise(resolve => setTimeout(resolve, 500));
            
            closeDataShieldRefreshModal();
            window.location.reload();
        } else {
            loading.style.display = 'none';
            content.style.display = 'block';
            buttons.style.display = 'flex';
            alert('Error: ' + (data.error || 'Unknown error'));
            btn.disabled = false;
            cancelBtn.disabled = false;
        }
    } catch (error) {
        loading.style.display = 'none';
        content.style.display = 'block';
        buttons.style.display = 'flex';
        alert('Error: ' + error.message);
        btn.disabled = false;
        cancelBtn.disabled = false;
    }
}
</script>
{% endblock %}

